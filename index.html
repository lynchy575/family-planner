<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family Planner</title>
    <link href="https://unpkg.com/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; }
      #calendar { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
      .fc .fc-toolbar-title { font-size: 1.25rem; }
    </style>
  </head>
  <body>
    <div id="calendar"></div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
      // ✅ SET THIS to your Apps Script /exec JSON endpoint
      const FEED_URL = 'https://script.google.com/macros/s/AKfycbzC74vunpbgzQMcBE7IXYf1twhbd9fat2p9rabFbCeAURpS87iimbCZGsOJhex2auT8/exec?format=json';

      document.addEventListener('DOMContentLoaded', function() {
        const el = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
          },

          // Show start and end times
          displayEventTime: true,
          displayEventEnd: true,
          eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },

          // Prepend time text to the title
          eventContent(info) {
            const time = info.timeText ? info.timeText + ' ' : '';
            return { html: `<span>${time}${info.event.title}</span>` };
          },

          // Load events
          events: async function(fetchInfo, success, failure) {
            try {
              const url = new URL(FEED_URL);
              url.searchParams.set('start', fetchInfo.startStr);
              url.searchParams.set('end', fetchInfo.endStr);
              url.searchParams.set('v', Date.now()); // cache-bust
              const res = await fetch(url.toString());
              if (!res.ok) throw new Error('Feed HTTP ' + res.status);
              const data = await res.json();
              const fcEvents = data.map(e => ({
                id: e.id,
                title: e.title,
                start: e.start || null,
                end: e.end || null,
                allDay: !!e.allDay,
                extendedProps: { person: e.person, type: e.type, location: e.location, notes: e.notes, color: e.color }
              }));
              success(fcEvents);
            } catch (err) {
              console.error('Fetch error:', err);
              failure(err);
            }
          },

          eventDidMount(info) {
            const c = info.event.extendedProps.color;
            if (c) {
              info.el.style.borderColor = c;
              info.el.style.backgroundColor = c;
              info.el.style.color = '#000';
            }
          },

          eventClick(info) {
            const e = info.event.extendedProps;
            const parts = [
              `Who: ${e.person || '—'}`,
              `Type: ${e.type || '—'}`,
              `Location: ${e.location || '—'}`,
              e.notes ? `Notes: ${e.notes}` : ''
            ].filter(Boolean).join('\n');
            alert(info.event.title + '\n\n' + parts);
          }
        });

        calendar.render();
      });
    </script>
  </body>
</html>
